import api.repository.task.tasks as tasks_repo
from api import redis as redis
from api.model.exploit_model import ExploitResult, ExploitStatus
from api.repository.exploit.db import exploits as exploit_db
from api.repository.exploit.exploit import get_exploit, get_exploit_status
from tasks import tasks as tasks


def start_first_exploit(exploit_id: int):
    """
    Запустить эксплоит на сервис.
    """
    exp = get_exploit(exploit_id)

    task = tasks_repo.get_task_info(exp.task_id)
    if task is None:
        raise ValueError("No such task")

    run_id = exploit_db.create_first_exploit_run(exploit_id, task.image_path)


def get_first_exploit_status(
    user_id: int, task_id: int
) -> None | tuple[ExploitStatus | None, ExploitResult | None]:
    first_exploit_run = exploit_db.get_first_exploit_run(user_id, task_id)
    if first_exploit_run is None:
        return None
    return get_exploit_status(first_exploit_run)
